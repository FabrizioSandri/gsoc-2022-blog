<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Rcpp package fuzz testing with RcppDeepState | GSOC 2022</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Rcpp package fuzz testing with RcppDeepState" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An quick overview of package fuzz testing using RcppDeepState" />
<meta property="og:description" content="An quick overview of package fuzz testing using RcppDeepState" />
<link rel="canonical" href="https://fabriziosandri.github.io/gsoc-2022-blog/rcppdeepstate/fuzz/r/c++/2022/06/07/rcppdeepstate-automatic-fuzz-testing-copy.html" />
<meta property="og:url" content="https://fabriziosandri.github.io/gsoc-2022-blog/rcppdeepstate/fuzz/r/c++/2022/06/07/rcppdeepstate-automatic-fuzz-testing-copy.html" />
<meta property="og:site_name" content="GSOC 2022" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-07T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Rcpp package fuzz testing with RcppDeepState" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-07T00:00:00-05:00","datePublished":"2022-06-07T00:00:00-05:00","description":"An quick overview of package fuzz testing using RcppDeepState","headline":"Rcpp package fuzz testing with RcppDeepState","mainEntityOfPage":{"@type":"WebPage","@id":"https://fabriziosandri.github.io/gsoc-2022-blog/rcppdeepstate/fuzz/r/c++/2022/06/07/rcppdeepstate-automatic-fuzz-testing-copy.html"},"url":"https://fabriziosandri.github.io/gsoc-2022-blog/rcppdeepstate/fuzz/r/c++/2022/06/07/rcppdeepstate-automatic-fuzz-testing-copy.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/gsoc-2022-blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://fabriziosandri.github.io/gsoc-2022-blog/feed.xml" title="GSOC 2022" /><link rel="shortcut icon" type="image/x-icon" href="/gsoc-2022-blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/gsoc-2022-blog/">GSOC 2022</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/gsoc-2022-blog/search/">Search</a><a class="page-link" href="/gsoc-2022-blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Rcpp package fuzz testing with RcppDeepState</h1><p class="page-description">An quick overview of package fuzz testing using RcppDeepState</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-07T00:00:00-05:00" itemprop="datePublished">
        Jun 7, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/gsoc-2022-blog/categories/#RcppDeepState">RcppDeepState</a>
        &nbsp;
      
        <a class="category-tags-link" href="/gsoc-2022-blog/categories/#fuzz">fuzz</a>
        &nbsp;
      
        <a class="category-tags-link" href="/gsoc-2022-blog/categories/#R">R</a>
        &nbsp;
      
        <a class="category-tags-link" href="/gsoc-2022-blog/categories/#c++">c++</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#automated-fuzz-testing">Automated fuzz testing</a>
<ul>
<li class="toc-entry toc-h2"><a href="#the-steps">The steps</a>
<ul>
<li class="toc-entry toc-h3"><a href="#the-compilation-procedure">The compilation procedure</a></li>
<li class="toc-entry toc-h3"><a href="#the-analysis-phase">The analysis phase</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#example">Example</a></li>
</ul>
</li>
</ul><h1 id="automated-fuzz-testing">
<a class="anchor" href="#automated-fuzz-testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Automated fuzz testing</h1>
<p>We saw how to manually create a Test Harness for a Rcpp written function in order to run fuzz testing on it in the previous blog article.
In practice, this strategy is never used: the majority of the time, the Harness construction process is automated.
This is what we’ll talk about in this blog article.</p>

<h2 id="the-steps">
<a class="anchor" href="#the-steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>The steps</h2>
<p>The RcppDeepState library was introduced in the previous post to do package fuzz testing. This library includes a collection of features that allow you to construct the test harness for a certain package function automatically.</p>

<p>RccpDeepState includes the following two key functions:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">deepstate_harness_compile_run</code></li>
  <li><code class="language-plaintext highlighter-rouge">deepstate_harness_analyze_pkg</code></li>
</ul>

<p>Let’s take a closer look at them.</p>

<h3 id="the-compilation-procedure">
<a class="anchor" href="#the-compilation-procedure" aria-hidden="true"><span class="octicon octicon-link"></span></a>The compilation procedure</h3>
<p>The function <code class="language-plaintext highlighter-rouge">deepstate_harness_compile_run(package_path)</code> is used to run the compilation process, and it accepts the location of the library we want to fuzz test.</p>

<p>This step begins by looking for any Rcpp written functions in the supplied library. This is accomplished by looking for information about the package’s exported functions, which are found in the <code class="language-plaintext highlighter-rouge">RcppExports.cpp</code> file in the <code class="language-plaintext highlighter-rouge">src</code> source folder. Once you’ve gathered all of the data, you’ll need to construct a test harness file. This phase is done by <code class="language-plaintext highlighter-rouge">deepstate_pkg_create</code>, which generates a Harness file for each function discovered in <code class="language-plaintext highlighter-rouge">&lt;package_dir&gt;/inst/testfiles/&lt;function_name&gt;</code>. This file includes the headers as well as the ‘TEST’ function definition, which includes all of the symbolic variables.</p>

<p>Using the <code class="language-plaintext highlighter-rouge">R CMD INSTALL</code> command, a shared object for the library is also produced (<code class="language-plaintext highlighter-rouge">.so</code> file). It’s worth noting that the shared object must be compiled with the <code class="language-plaintext highlighter-rouge">-g</code> option in order to include debug symbols.
I discovered that the shared object was produced without debugging symbols on some Linux systems. I wrote an additional piece of code to rewrite the <code class="language-plaintext highlighter-rouge">Makevars</code> file holding the compilation parameters in order to solve the problem. This issue is solved in the <a href="https://github.com/FabrizioSandri/RcppDeepState/pull/3">Pull request #3</a>.</p>

<p>The fuzz testing approach begins once the library and harness have been generated: the output of the tests is stored in order to evaluate them later using Valgrind.</p>

<h3 id="the-analysis-phase">
<a class="anchor" href="#the-analysis-phase" aria-hidden="true"><span class="octicon octicon-link"></span></a>The analysis phase</h3>
<p>Following the completion of the fuzz testing, the next step is to analyze the inputs generated. This is done using <code class="language-plaintext highlighter-rouge">deepstate_harness_analyze_pkg(package_path)</code>. This function looks for binary files containing the inputs in the <code class="language-plaintext highlighter-rouge">&lt;package_dir&gt;/inst/testfiles</code> directory. The harness is then rerun with the <code class="language-plaintext highlighter-rouge">--input_test_file</code> option: this allows to provide an input test case. It’s worth noting that in this second stage, the harness is examined by the Valgrind Memcheck tool, resulting in an XML log file.</p>

<p>RcppDeepState then parses this file for error information (message, line number, etc.) and returns them to the <code class="language-plaintext highlighter-rouge">deepstate_harness_analyze_pkg(package_path)</code> function.</p>

<h2 id="example">
<a class="anchor" href="#example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example</h2>
<p>RcppDeepState includes a sample library under the <code class="language-plaintext highlighter-rouge">RcppDeepState/inst/testpkgs/testSAN</code> folder. It can be useful as a toy library for detecting problems. Following the approach outlined in the previous part, we examine the package in this section.</p>

<p>The first step is to use <code class="language-plaintext highlighter-rouge">deepstate_harness_compile_run</code> to compile the library. This function prints a list of successfully constructed harness when the compilation processes are done. In this example, all of the functions were appropriately built. On the other hand, if any functions are not built, an error message is generated.</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">deepstate_harness_compile_run</span><span class="p">(</span><span class="s2">"RcppDeepState/inst/testpkgs/testSAN"</span><span class="p">)</span><span class="w">

</span><span class="n">...</span><span class="w"> </span><span class="n">compilation</span><span class="w"> </span><span class="n">steps</span><span class="w"> </span><span class="n">...</span><span class="w">

</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="s2">"rcpp_read_out_of_bound"</span><span class="w">      </span><span class="s2">"rcpp_use_after_deallocate"</span><span class="w">  
</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="w"> </span><span class="s2">"rcpp_use_after_free"</span><span class="w">         </span><span class="s2">"rcpp_use_uninitialized"</span><span class="w">     
</span><span class="p">[</span><span class="m">5</span><span class="p">]</span><span class="w"> </span><span class="s2">"rcpp_write_index_outofbound"</span><span class="w"> </span><span class="s2">"rcpp_zero_sized_array"</span><span class="w">  
</span></code></pre></div></div>

<p>The next step is to use Valgrind’s Memcheck tool to perform the analysis.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">deepstate_harness_analyze_pkg</span><span class="p">(</span><span class="s2">"RcppDeepState/inst/testpkgs/testSAN"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>We may get a detailed description of the faults detected by printing the contents of <code class="language-plaintext highlighter-rouge">result$logtable</code> :</p>
<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span><span class="w"> </span><span class="n">knitr</span><span class="o">::</span><span class="n">kable</span><span class="p">(</span><span class="n">result</span><span class="o">$</span><span class="n">logtable</span><span class="p">)</span><span class="w">
</span><span class="o">|</span><span class="n">err.kind</span><span class="w">    </span><span class="o">|</span><span class="n">message</span><span class="w">                </span><span class="o">|</span><span class="n">file.line</span><span class="w">                    </span><span class="o">|</span><span class="n">address.msg</span><span class="w">                                                 </span><span class="o">|</span><span class="n">address.trace</span><span class="w">                </span><span class="o">|</span><span class="w">
</span><span class="o">|:-----------|:----------------------|:----------------------------|:-----------------------------------------------------------|:----------------------------|</span><span class="w">
</span><span class="o">|</span><span class="n">InvalidRead</span><span class="w"> </span><span class="o">|</span><span class="n">Invalid</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">|</span><span class="n">Address</span><span class="w"> </span><span class="mh">0x806cfe5</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">free</span><span class="s1">'d |use_after_deallocate.cpp : 6 |
|InvalidRead |Invalid read of size 1 |use_after_deallocate.cpp : 7 |Address 0x806cfe5 is 5 bytes after a block of size 0 free'</span><span class="n">d</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">|</span><span class="w">

</span><span class="o">|</span><span class="n">err.kind</span><span class="w">    </span><span class="o">|</span><span class="n">message</span><span class="w">                </span><span class="o">|</span><span class="n">file.line</span><span class="w">                    </span><span class="o">|</span><span class="n">address.msg</span><span class="w">                                                 </span><span class="o">|</span><span class="n">address.trace</span><span class="w">                </span><span class="o">|</span><span class="w">
</span><span class="o">|:-----------|:----------------------|:----------------------------|:-----------------------------------------------------------|:----------------------------|</span><span class="w">
</span><span class="o">|</span><span class="n">InvalidRead</span><span class="w"> </span><span class="o">|</span><span class="n">Invalid</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">|</span><span class="n">Address</span><span class="w"> </span><span class="mh">0x806cfe5</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">free</span><span class="s1">'d |use_after_deallocate.cpp : 6 |
|InvalidRead |Invalid read of size 1 |use_after_deallocate.cpp : 7 |Address 0x806cfe5 is 5 bytes after a block of size 0 free'</span><span class="n">d</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">|</span><span class="w">

</span><span class="o">|</span><span class="n">err.kind</span><span class="w">    </span><span class="o">|</span><span class="n">message</span><span class="w">                </span><span class="o">|</span><span class="n">file.line</span><span class="w">                    </span><span class="o">|</span><span class="n">address.msg</span><span class="w">                                                 </span><span class="o">|</span><span class="n">address.trace</span><span class="w">                </span><span class="o">|</span><span class="w">
</span><span class="o">|:-----------|:----------------------|:----------------------------|:-----------------------------------------------------------|:----------------------------|</span><span class="w">
</span><span class="o">|</span><span class="n">InvalidRead</span><span class="w"> </span><span class="o">|</span><span class="n">Invalid</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="o">|</span><span class="n">Address</span><span class="w"> </span><span class="mh">0x806cfe5</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">after</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="n">free</span><span class="s1">'d |use_after_deallocate.cpp : 6 |
|InvalidRead |Invalid read of size 1 |use_after_deallocate.cpp : 7 |Address 0x806cfe5 is 5 bytes after a block of size 0 free'</span><span class="n">d</span><span class="w"> </span><span class="o">|</span><span class="n">use_after_deallocate.cpp</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="o">|</span><span class="w">


</span></code></pre></div></div>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="FabrizioSandri/gsoc-2022-blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/gsoc-2022-blog/rcppdeepstate/fuzz/r/c++/2022/06/07/rcppdeepstate-automatic-fuzz-testing-copy.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/gsoc-2022-blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/gsoc-2022-blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/gsoc-2022-blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Blog for the GSOC 2022 edition | RcppDeepState</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/FabrizioSandri" target="_blank" title="FabrizioSandri"><svg class="svg-icon grey"><use xlink:href="/gsoc-2022-blog/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
